<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 김프 대시보드 (TwelveData 기반)</title>
    <meta name="description" content="비트코인, 이더리움 김치프리미엄 실시간 확인. Twelve Data 실시간 환율 기반.">
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #999;
            --premium-positive: #e74c3c;
            --premium-negative: #3498db;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        .dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #2d2d44;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --text-light: #808080;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh; padding: 20px; color: var(--text-primary);
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 20px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px 20px; margin-bottom: 16px;
                box-shadow: 0 4px 6px var(--shadow); text-align: center; transition: all 0.3s ease; }
        .card-title { font-size: 16px; color: var(--text-secondary); margin-bottom: 10px; font-weight: bold; }
        .card-value { font-size: 32px; font-weight: bold; color: var(--text-primary); }
        .card-sub { font-size: 14px; color: var(--text-light); margin-bottom: 6px; }
        .source-tag { display: inline-block; background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-top: 4px; }
        .premium { font-weight: 600; font-size: 15px; }
        .premium.positive { color: var(--premium-positive); }
        .premium.negative { color: var(--premium-negative); }
        .section-title { color: white; font-size: 18px; font-weight: bold; text-align: center; margin: 24px 0 16px 0; }
        .refresh-btn {
            background: white; border: none; border-radius: 12px; padding: 12px 24px;
            font-size: 14px; font-weight: 600; color: #667eea; cursor: pointer; width: 100%; margin-top: 16px;
            box-shadow: 0 4px 6px var(--shadow);
        }
        .refresh-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💱 실시간 환율 & 김치 프리미엄</h1>
            <div id="updateTime" style="font-size:13px; opacity:0.85;">데이터 로딩 중...</div>
        </div>
        <div id="content" class="loading">데이터를 불러오는 중...</div>
    </div>

    <script>
        // ======================
        // ⚙️ CONFIG
        // ======================
        const WORKER_BASE_URL = "https://kimchi-worker.yourname.workers.dev"; // ← 본인 주소로 교체
        const CONFIG = { UPDATE_INTERVAL: 30000, MIN_VALID_EXCHANGE_RATE: 100 };

        // ======================
        // 🧩 유틸리티
        // ======================
        const fetchWithTimeout = (url, timeout = 10000) => {
            return Promise.race([
                fetch(url),
                new Promise((_, reject) => setTimeout(() => reject(new Error('요청 시간 초과')), timeout))
            ]).then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            });
        };

        const showNotification = (msg) => console.log("✅", msg);

        // ======================
        // 💱 API 호출
        // ======================
        const getExchangeRate = async () => {
            const response = await fetchWithTimeout(`${WORKER_BASE_URL}/usdkrw`);
            const data = await response.json();
            if (!data?.rate) throw new Error("환율 데이터 형식 오류");
            localStorage.setItem("twelveDataTimestamp", data.timestamp || new Date().toISOString());
            return data.rate;
        };

        const getUpbitPrices = async () => {
            const response = await fetchWithTimeout('https://api.upbit.com/v1/ticker?markets=KRW-USDT,KRW-BTC,USDT-BTC');
            const data = await response.json();
            const result = { usdt: 0, btcKrw: 0, btcUsdt: 0 };
            data.forEach(item => {
                if (item.market === 'KRW-USDT') result.usdt = item.trade_price;
                if (item.market === 'KRW-BTC') result.btcKrw = item.trade_price;
                if (item.market === 'USDT-BTC') result.btcUsdt = item.trade_price;
            });
            return result;
        };

        const getBinanceStablePrice = async () => {
            const response = await fetchWithTimeout(`${WORKER_BASE_URL}/usdtusd`);
            const data = await response.json();
            if (!data?.rate) throw new Error("USDT 데이터 오류");
            return { usdt: data.rate, usdc: 1.0000 };
        };

        // ======================
        // 🧠 렌더링
        // ======================
        const renderPremium = (value) => {
            if (value === "N/A") return `<div class="premium" style="color:#999">N/A</div>`;
            const num = parseFloat(value);
            const cls = num >= 0 ? "positive" : "negative";
            const sign = num >= 0 ? "+" : "";
            return `<div class="premium ${cls}">${sign}${num}%</div>`;
        };

        const displayData = (data) => {
            const twelveDataTime = localStorage.getItem("twelveDataTimestamp");
            const twelveDisplay = twelveDataTime
                ? new Date(twelveDataTime).toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", second: "2-digit" })
                : "N/A";

            document.getElementById("updateTime").innerHTML =
                `마지막 업데이트: ${new Date().toLocaleTimeString("ko-KR")} · Twelve Data 기준 ${twelveDisplay}`;

            const content = `
                <div class="card">
                    <div class="card-title">USD/KRW 환율</div>
                    <div class="card-value">₩${data.usdKrw}</div>
                    <div class="card-sub">1달러당</div>
                    <span class="source-tag">출처: Twelve Data</span><br>
                    <span style="font-size:12px; color:var(--text-secondary)">갱신: ${twelveDisplay}</span>
                </div>

                <div class="section-title">💲 스테이블코인 김프</div>
                <div class="card">
                    <div class="card-title">USDT (테더)</div>
                    <div class="card-value">₩${data.upbitUsdt.toLocaleString('ko-KR')}</div>
                    ${renderPremium(data.usdtPremium)}
                    <div class="card-sub">환율 기준: ₩${data.usdKrw}</div>
                    <span class="source-tag">업비트 / Twelve Data</span>
                </div>

                <div class="section-title">📈 비트코인 김프</div>
                <div class="card">
                    <div class="card-title">BTC</div>
                    <div class="card-value">${data.btcKimp}%</div>
                    <div class="card-sub">업비트 vs 바이낸스</div>
                    <span class="source-tag">Twelve Data + Upbit</span>
                </div>

                <button class="refresh-btn" onclick="fetchData()">🔄 새로고침</button>
            `;
            document.getElementById("content").innerHTML = content;
        };

        // ======================
        // 🔄 데이터 수집
        // ======================
        const fetchData = async () => {
            try {
                const [usdKrw, upbit, stable] = await Promise.all([
                    getExchangeRate(),
                    getUpbitPrices(),
                    getBinanceStablePrice()
                ]);
                if (usdKrw < CONFIG.MIN_VALID_EXCHANGE_RATE) throw new Error("환율 데이터 오류");

                const usdtPremium = ((upbit.usdt / usdKrw - 1) * 100).toFixed(2);
                const btcKimp = ((upbit.btcKrw / (upbit.btcUsdt * usdKrw) - 1) * 100).toFixed(2);

                const data = {
                    usdKrw: usdKrw.toFixed(2),
                    upbitUsdt: upbit.usdt,
                    usdtPremium,
                    btcKimp
                };
                displayData(data);
            } catch (e) {
                document.getElementById("content").innerHTML =
                    `<div class="card" style="color:red;">❌ 데이터 오류: ${e.message}</div>`;
            }
        };

        // ======================
        // 🚀 초기화
        // ======================
        fetchData();
        setInterval(fetchData, CONFIG.UPDATE_INTERVAL);
    </script>
</body>
</html>