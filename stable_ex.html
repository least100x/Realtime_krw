

// ============ ë°”ì´ë‚¸ìŠ¤ P2P ì‹œì¥ìœ¼ë¡œ ì‹¤ì‹œê°„ í™˜ìœ¨ êµ¬í•˜ê¸° ============

// ì›ë¦¬: ë°”ì´ë‚¸ìŠ¤ P2Pì—ì„œ í•œêµ­ì¸ë“¤ì´ USDTë¥¼ KRWë¡œ ê±°ë˜í•˜ëŠ” ê°€ê²©
// = ì‹¤ì œ ì‹œì¥ì—ì„œ í˜•ì„±ë˜ëŠ” ì‹¤ì‹œê°„ USD/KRW í™˜ìœ¨!

const getBinanceP2PRate = async () => {
try {
// ë°”ì´ë‚¸ìŠ¤ P2P API (ê³µì‹ API, í‚¤ ë¶ˆí•„ìš”)
const response = await fetch(â€˜https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/searchâ€™, {
method: â€˜POSTâ€™,
headers: {
â€˜Content-Typeâ€™: â€˜application/jsonâ€™,
},
body: JSON.stringify({
â€œassetâ€: â€œUSDTâ€,
â€œfiatâ€: â€œKRWâ€,
â€œmerchantCheckâ€: true,
â€œpageâ€: 1,
â€œpayTypesâ€: [],
â€œpublisherTypeâ€: null,
â€œrowsâ€: 10,
â€œtradeTypeâ€: â€œBUYâ€
})
});


    const data = await response.json();
    
    if (!data.data || data.data.length === 0) {
        throw new Error('P2P ë°ì´í„° ì—†ìŒ');
    }

    // ìƒìœ„ 10ê°œ ë§¤ë¬¼ì˜ í‰ê·  ê°€ê²©
    const prices = data.data
        .slice(0, 10)
        .map(item => parseFloat(item.adv.price));

    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

    return {
        rate: avgPrice,
        source: 'Binance P2P',
        realtime: true,
        samples: prices.length,
        range: {
            min: Math.min(...prices),
            max: Math.max(...prices)
        }
    };

} catch (error) {
    console.error('ë°”ì´ë‚¸ìŠ¤ P2P ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw error;
}


};

// ============ ëŒ€ì•ˆ: FTX/Kraken OTC ê°€ê²© ============

// ì—…ë¹„íŠ¸ ì™¸ë¶€ ì†¡ê¸ˆ ì‹œì„¸ë¡œ ì—­ì‚°
const getUpbitWithdrawalRate = async () => {
try {
// ì—…ë¹„íŠ¸ ì™¸ë¶€ ì†¡ê¸ˆ ì‹œì„¸ ì¡°íšŒ
const response = await fetch(â€˜https://api.upbit.com/v1/ticker?markets=KRW-BTC,BTC-USDTâ€™);
const data = await response.json();


    // KRW-BTCì™€ BTC-USDTë¥¼ ì¡°í•©í•´ì„œ KRW-USDT ê³„ì‚°
    // ì´ê±´ ì—…ë¹„íŠ¸ ë‚´ë¶€ ì‹œì„¸ê°€ ì•„ë‹ˆë¼ ì™¸ë¶€ ì†¡ê¸ˆ ê¸°ì¤€

    // ... ë³µì¡í•¨, ì¶”ì²œ ì•ˆí•¨
    
} catch (error) {
    throw error;
}


};

// ============ ìµœì¢… í˜¼í•© ì „ëµ ============

const getRealTimeExchangeRate = async () => {
try {
// 1ìˆœìœ„: ë°”ì´ë‚¸ìŠ¤ P2P (ì‹¤ì‹œê°„, ë¬´ë£Œ, ì •í™•)
console.log(â€˜ğŸ”„ ë°”ì´ë‚¸ìŠ¤ P2P ì‹œì¥ ì¡°íšŒ ì¤‘â€¦â€™);
const p2pResult = await getBinanceP2PRate();


    console.log(`âœ… P2P í™˜ìœ¨: â‚©${p2pResult.rate.toFixed(2)}`);
    console.log(`   ë²”ìœ„: â‚©${p2pResult.range.min.toFixed(2)} ~ â‚©${p2pResult.range.max.toFixed(2)}`);
    
    return p2pResult.rate;
    
} catch (error) {
    console.error('âš ï¸ P2P ì‹¤íŒ¨, ì •ì  APIë¡œ í´ë°±:', error);
    
    // 2ìˆœìœ„: ê¸°ì¡´ ì •ì  API
    const sources = await Promise.allSettled([
        fetch('https://api.frankfurter.app/latest?from=USD&to=KRW')
            .then(r => r.json()).then(d => d.rates.KRW),
        
        fetch('https://open.er-api.com/v6/latest/USD')
            .then(r => r.json()).then(d => d.rates.KRW)
    ]);

    const validRates = sources
        .filter(r => r.status === 'fulfilled' && r.value > 1000)
        .map(r => r.value);

    if (validRates.length === 0) {
        throw new Error('ëª¨ë“  í™˜ìœ¨ ì†ŒìŠ¤ ì‹¤íŒ¨');
    }

    const avg = validRates.reduce((a, b) => a + b, 0) / validRates.length;
    console.log(`âœ… ì •ì  API: â‚©${avg.toFixed(2)} (ì‹¤ì‹œê°„ ì•„ë‹˜)`);
    
    return avg;
}


};

// ============ í…ŒìŠ¤íŠ¸ ============

async function testP2PvsStatic() {
console.log(â€™=â€™.repeat(60));
console.log(â€˜ğŸ’± P2P vs ì •ì  API ë¹„êµâ€™);
console.log(â€™=â€™.repeat(60));


// P2P
try {
    const p2p = await getBinanceP2PRate();
    console.log(`\nâœ… ë°”ì´ë‚¸ìŠ¤ P2P (ì‹¤ì‹œê°„)`);
    console.log(`   í‰ê· : â‚©${p2p.rate.toFixed(2)}`);
    console.log(`   ìµœì €: â‚©${p2p.range.min.toFixed(2)}`);
    console.log(`   ìµœê³ : â‚©${p2p.range.max.toFixed(2)}`);
    console.log(`   ìƒ˜í”Œ: ${p2p.samples}ê°œ ë§¤ë¬¼`);
} catch (e) {
    console.log(`\nâŒ P2P ì‹¤íŒ¨: ${e.message}`);
}

// ì •ì  API
try {
    const frank = await fetch('https://api.frankfurter.app/latest?from=USD&to=KRW')
        .then(r => r.json());
    console.log(`\nğŸ“… Frankfurter (ì •ì )`);
    console.log(`   í™˜ìœ¨: â‚©${frank.rates.KRW.toFixed(2)}`);
    console.log(`   ë‚ ì§œ: ${frank.date}`);
} catch (e) {
    console.log(`\nâŒ Frankfurter ì‹¤íŒ¨`);
}

try {
    const erapi = await fetch('https://open.er-api.com/v6/latest/USD')
        .then(r => r.json());
    console.log(`\nğŸ“… Open.ER-API (ì •ì )`);
    console.log(`   í™˜ìœ¨: â‚©${erapi.rates.KRW.toFixed(2)}`);
} catch (e) {
    console.log(`\nâŒ Open.ER-API ì‹¤íŒ¨`);
}

console.log('\n' + '='.repeat(60));


}

// ì‹¤í–‰
testP2PvsStatic();