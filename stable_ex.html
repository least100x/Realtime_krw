

// ============ 바이낸스 P2P 시장으로 실시간 환율 구하기 ============

// 원리: 바이낸스 P2P에서 한국인들이 USDT를 KRW로 거래하는 가격
// = 실제 시장에서 형성되는 실시간 USD/KRW 환율!

const getBinanceP2PRate = async () => {
try {
// 바이낸스 P2P API (공식 API, 키 불필요)
const response = await fetch(‘https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search’, {
method: ‘POST’,
headers: {
‘Content-Type’: ‘application/json’,
},
body: JSON.stringify({
“asset”: “USDT”,
“fiat”: “KRW”,
“merchantCheck”: true,
“page”: 1,
“payTypes”: [],
“publisherType”: null,
“rows”: 10,
“tradeType”: “BUY”
})
});


    const data = await response.json();
    
    if (!data.data || data.data.length === 0) {
        throw new Error('P2P 데이터 없음');
    }

    // 상위 10개 매물의 평균 가격
    const prices = data.data
        .slice(0, 10)
        .map(item => parseFloat(item.adv.price));

    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

    return {
        rate: avgPrice,
        source: 'Binance P2P',
        realtime: true,
        samples: prices.length,
        range: {
            min: Math.min(...prices),
            max: Math.max(...prices)
        }
    };

} catch (error) {
    console.error('바이낸스 P2P 조회 실패:', error);
    throw error;
}


};

// ============ 대안: FTX/Kraken OTC 가격 ============

// 업비트 외부 송금 시세로 역산
const getUpbitWithdrawalRate = async () => {
try {
// 업비트 외부 송금 시세 조회
const response = await fetch(‘https://api.upbit.com/v1/ticker?markets=KRW-BTC,BTC-USDT’);
const data = await response.json();


    // KRW-BTC와 BTC-USDT를 조합해서 KRW-USDT 계산
    // 이건 업비트 내부 시세가 아니라 외부 송금 기준

    // ... 복잡함, 추천 안함
    
} catch (error) {
    throw error;
}


};

// ============ 최종 혼합 전략 ============

const getRealTimeExchangeRate = async () => {
try {
// 1순위: 바이낸스 P2P (실시간, 무료, 정확)
console.log(‘🔄 바이낸스 P2P 시장 조회 중…’);
const p2pResult = await getBinanceP2PRate();


    console.log(`✅ P2P 환율: ₩${p2pResult.rate.toFixed(2)}`);
    console.log(`   범위: ₩${p2pResult.range.min.toFixed(2)} ~ ₩${p2pResult.range.max.toFixed(2)}`);
    
    return p2pResult.rate;
    
} catch (error) {
    console.error('⚠️ P2P 실패, 정적 API로 폴백:', error);
    
    // 2순위: 기존 정적 API
    const sources = await Promise.allSettled([
        fetch('https://api.frankfurter.app/latest?from=USD&to=KRW')
            .then(r => r.json()).then(d => d.rates.KRW),
        
        fetch('https://open.er-api.com/v6/latest/USD')
            .then(r => r.json()).then(d => d.rates.KRW)
    ]);

    const validRates = sources
        .filter(r => r.status === 'fulfilled' && r.value > 1000)
        .map(r => r.value);

    if (validRates.length === 0) {
        throw new Error('모든 환율 소스 실패');
    }

    const avg = validRates.reduce((a, b) => a + b, 0) / validRates.length;
    console.log(`✅ 정적 API: ₩${avg.toFixed(2)} (실시간 아님)`);
    
    return avg;
}


};

// ============ 테스트 ============

async function testP2PvsStatic() {
console.log(’=’.repeat(60));
console.log(‘💱 P2P vs 정적 API 비교’);
console.log(’=’.repeat(60));


// P2P
try {
    const p2p = await getBinanceP2PRate();
    console.log(`\n✅ 바이낸스 P2P (실시간)`);
    console.log(`   평균: ₩${p2p.rate.toFixed(2)}`);
    console.log(`   최저: ₩${p2p.range.min.toFixed(2)}`);
    console.log(`   최고: ₩${p2p.range.max.toFixed(2)}`);
    console.log(`   샘플: ${p2p.samples}개 매물`);
} catch (e) {
    console.log(`\n❌ P2P 실패: ${e.message}`);
}

// 정적 API
try {
    const frank = await fetch('https://api.frankfurter.app/latest?from=USD&to=KRW')
        .then(r => r.json());
    console.log(`\n📅 Frankfurter (정적)`);
    console.log(`   환율: ₩${frank.rates.KRW.toFixed(2)}`);
    console.log(`   날짜: ${frank.date}`);
} catch (e) {
    console.log(`\n❌ Frankfurter 실패`);
}

try {
    const erapi = await fetch('https://open.er-api.com/v6/latest/USD')
        .then(r => r.json());
    console.log(`\n📅 Open.ER-API (정적)`);
    console.log(`   환율: ₩${erapi.rates.KRW.toFixed(2)}`);
} catch (e) {
    console.log(`\n❌ Open.ER-API 실패`);
}

console.log('\n' + '='.repeat(60));


}

// 실행
testP2PvsStatic();