<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ í™˜ìœ¨ & ê¹€í”„ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .update-time {
            font-size: 14px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .card-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .card-sub {
            font-size: 14px;
            color: #999;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .small-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .small-card-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .small-card-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .premium {
            font-size: 14px;
            margin-top: 4px;
            font-weight: 600;
        }

        .premium.positive {
            color: #e74c3c;
        }

        .premium.negative {
            color: #3498db;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .refresh-btn {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .refresh-btn:active {
            transform: scale(0.98);
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 13px;
            line-height: 1.6;
            color: #555;
        }

        .info-card strong {
            color: #333;
        }

        .source-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 4px;
        }

        @media (max-width: 480px) {
            .card-value {
                font-size: 24px;
            }
            
            .small-card-value {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’± ì‹¤ì‹œê°„ í™˜ìœ¨ & ê¹€í”„</h1>
            <div class="update-time" id="updateTime">ë¡œë”© ì¤‘...</div>
        </div>

        <div id="content" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <script>
        // ìºì‹œ ì‹œìŠ¤í…œ
        const cache = {
            data: null,
            timestamp: 0,
            TTL: 30000 // 30ì´ˆ ìºì‹œ
        };

        let isLoading = false;
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // ëŒ€ê¸° í•¨ìˆ˜
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // íƒ€ì„ì•„ì›ƒ ë° ì¬ì‹œë„ ë¡œì§
        async function fetchWithTimeout(url, timeout = 8000, retries = 2) {
            for (let i = 0; i <= retries; i++) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(id);
                    
                    // 429 ì—ëŸ¬ ì²˜ë¦¬ - ì§€ìˆ˜ ë°±ì˜¤í”„
                    if (response.status === 429) {
                        const waitTime = Math.pow(2, i) * 2000; // 2ì´ˆ, 4ì´ˆ, 8ì´ˆ
                        console.warn(`API ìš”ì²­ ì œí•œ. ${waitTime/1000}ì´ˆ í›„ ì¬ì‹œë„... (${i+1}/${retries+1})`);
                        
                        if (i < retries) {
                            await sleep(waitTime);
                            continue;
                        }
                        throw new Error('API ìš”ì²­ ì œí•œ ì´ˆê³¼');
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    return response;
                } catch (error) {
                    clearTimeout(id);
                    
                    if (i < retries && !error.message.includes('aborted')) {
                        const waitTime = Math.pow(2, i) * 1000;
                        console.log(`ì¬ì‹œë„ ëŒ€ê¸° ì¤‘... (${i+1}/${retries+1})`);
                        await sleep(waitTime);
                        continue;
                    }
                    throw error;
                }
            }
        }

        // í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸° (ì—¬ëŸ¬ API ì‹œë„)
        async function getExchangeRate() {
            const apis = [
                {
                    url: 'https://open.er-api.com/v6/latest/USD',
                    parse: (data) => data.rates.KRW
                },
                {
                    url: 'https://api.exchangerate-api.com/v4/latest/USD',
                    parse: (data) => data.rates.KRW
                },
                {
                    url: 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json',
                    parse: (data) => data.usd.krw
                }
            ];

            for (const api of apis) {
                try {
                    console.log(`í™˜ìœ¨ API ì‹œë„: ${api.url}`);
                    const res = await fetchWithTimeout(api.url, 3000);
                    const data = await res.json();
                    const rate = api.parse(data);
                    if (rate && rate > 0) {
                        console.log(`í™˜ìœ¨ API ì„±ê³µ: ${rate}`);
                        return rate;
                    }
                } catch (e) {
                    console.log(`í™˜ìœ¨ API ì‹¤íŒ¨: ${api.url}`, e.message);
                    continue;
                }
            }
            
            console.warn('ëª¨ë“  í™˜ìœ¨ API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
            return 1300;
        }

        async function fetchData() {
            // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
            if (isLoading) {
                console.log('ì´ë¯¸ ë¡œë”© ì¤‘...');
                return;
            }

            // ìºì‹œ í™•ì¸ (30ì´ˆ ì´ë‚´ë©´ ìºì‹œ ì‚¬ìš©)
            const now = Date.now();
            if (cache.data && (now - cache.timestamp) < cache.TTL) {
                console.log('ìºì‹œëœ ë°ì´í„° ì‚¬ìš©');
                displayData(cache.data);
                return;
            }

            isLoading = true;
            const startTime = Date.now();
            
            try {
                console.log('=== ë°ì´í„° ë¡œë”© ì‹œì‘ ===');
                
                // í™˜ìœ¨ê³¼ ì—…ë¹„íŠ¸ ë°ì´í„° ë™ì‹œ ìš”ì²­
                const [usdKrw, upbitRes] = await Promise.all([
                    getExchangeRate(),
                    fetchWithTimeout('https://api.upbit.com/v1/ticker?markets=KRW-USDT,KRW-USDC', 10000, 2)
                ]);

                const upbitData = await upbitRes.json();
                
                const upbitUsdt = upbitData.find(item => item.market === 'KRW-USDT')?.trade_price || 0;
                const upbitUsdc = upbitData.find(item => item.market === 'KRW-USDC')?.trade_price || 0;

                if (!upbitUsdt || !upbitUsdc) {
                    throw new Error('ì—…ë¹„íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                // ê¹€í”„ ê³„ì‚°
                const usdtPremium = ((upbitUsdt / usdKrw - 1) * 100).toFixed(2);
                const usdcPremium = ((upbitUsdc / usdKrw - 1) * 100).toFixed(2);

                const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
                console.log(`=== ë°ì´í„° ë¡œë”© ì™„ë£Œ (${loadTime}ì´ˆ) ===`);

                const resultData = {
                    usdKrw: usdKrw.toFixed(2),
                    upbitUsdt: upbitUsdt.toLocaleString('ko-KR'),
                    upbitUsdc: upbitUsdc.toLocaleString('ko-KR'),
                    usdtPremium,
                    usdcPremium,
                    loadTime
                };

                // ìºì‹œ ì €ì¥
                cache.data = resultData;
                cache.timestamp = Date.now();
                retryCount = 0; // ì„±ê³µ ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”

                displayData(resultData);

            } catch (error) {
                console.error('=== ì˜¤ë¥˜ ë°œìƒ ===', error);
                retryCount++;

                // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ (1ì‹œê°„ ì´ë‚´)
                if (cache.data && (Date.now() - cache.timestamp) < 3600000) {
                    console.log('ì˜¤ë¥˜ ë°œìƒ, ìºì‹œëœ ë°ì´í„° í‘œì‹œ');
                    displayData(cache.data, true);
                    return;
                }

                // ì¬ì‹œë„ ê¶Œì¥ ì‹œê°„ ê³„ì‚°
                const waitMinutes = Math.min(retryCount * 2, 10);
                
                document.getElementById('content').innerHTML = `
                    <div style="color: white; text-align: center;">
                        <p style="font-size: 18px; margin-bottom: 15px;">âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="font-size: 14px; margin-top: 10px;">ì˜¤ë¥˜: ${error.message}</p>
                        <p style="font-size: 13px; margin-top: 15px; opacity: 0.9; line-height: 1.6;">
                            ${retryCount >= MAX_RETRIES 
                                ? `ë„ˆë¬´ ë§ì€ ìš”ì²­ìœ¼ë¡œ API ì œí•œì´ ê±¸ë ¸ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ì•½ ${waitMinutes}ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
                                : 'ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•˜ê±°ë‚˜ API ì„œë²„ì— ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                            }
                        </p>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 12px;">
                            <strong>ğŸ’¡ í•´ê²° ë°©ë²•</strong><br>
                            1. 1-2ë¶„ ì •ë„ ê¸°ë‹¤ë¦° í›„ ìƒˆë¡œê³ ì¹¨<br>
                            2. ë¸Œë¼ìš°ì € íƒ­ì„ ë‹«ì•˜ë‹¤ê°€ ë‹¤ì‹œ ì—´ê¸°<br>
                            3. ì‹œí¬ë¦¿ ëª¨ë“œë¡œ ì ‘ì†í•´ë³´ê¸°
                        </div>
                        <button class="refresh-btn" onclick="manualRefresh()" style="margin-top: 15px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„ ${retryCount >= MAX_RETRIES ? `(${waitMinutes}ë¶„ í›„ ê¶Œì¥)` : ''}
                        </button>
                    </div>
                `;
            } finally {
                isLoading = false;
            }
        }

        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ë¬´ì‹œ)
        async function manualRefresh() {
            cache.timestamp = 0; // ìºì‹œ ë¬´íš¨í™”
            await fetchData();
        }

        function displayData(data, isFromCache = false) {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const cacheWarning = isFromCache ? ' <span style="color: #f39c12;">(ìºì‹œ)</span>' : '';
            document.getElementById('updateTime').innerHTML = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeString} (${data.loadTime}ì´ˆ)${cacheWarning}`;

            const content = `
                <div class="card">
                    <div class="card-title">USD/KRW í™˜ìœ¨</div>
                    <div class="card-value">â‚©${data.usdKrw}</div>
                    <div class="card-sub">1ë‹¬ëŸ¬ë‹¹</div>
                    <div class="source-tag">ExchangeRate-API</div>
                </div>

                <div class="grid">
                    <div class="small-card">
                        <div class="small-card-title">USDT (í…Œë”)</div>
                        <div class="small-card-value">â‚©${data.upbitUsdt}</div>
                        <div class="premium ${data.usdtPremium >= 0 ? 'positive' : 'negative'}">
                            ${data.usdtPremium >= 0 ? '+' : ''}${data.usdtPremium}%
                        </div>
                        <div class="source-tag">ì—…ë¹„íŠ¸</div>
                    </div>

                    <div class="small-card">
                        <div class="small-card-title">USDC</div>
                        <div class="small-card-value">â‚©${data.upbitUsdc}</div>
                        <div class="premium ${data.usdcPremium >= 0 ? 'positive' : 'negative'}">
                            ${data.usdcPremium >= 0 ? '+' : ''}${data.usdcPremium}%
                        </div>
                        <div class="source-tag">ì—…ë¹„íŠ¸</div>
                    </div>
                </div>

                <div class="info-card">
                    <strong>ğŸ’¡ ìŠ¤í…Œì´ë¸”ì½”ì¸ì´ë€?</strong><br>
                    ë‹¬ëŸ¬ì™€ 1:1ë¡œ ê°€ì¹˜ê°€ ê³ ì •ëœ ì•”í˜¸í™”íì…ë‹ˆë‹¤.<br>
                    1 USDT = 1 USD, 1 USDC = 1 USD<br><br>
                    
                    <strong>ì™œ ê°€ê²© ì°¨ì´ê°€ ìƒê¸¸ê¹Œìš”?</strong><br>
                    â€¢ <strong>í•´ì™¸ ê±°ë˜ì†Œ</strong>: 1 USDT = 1ë‹¬ëŸ¬ë¡œ ê±°ë˜<br>
                    â€¢ <strong>í•œêµ­ ê±°ë˜ì†Œ</strong>: 1 USDT = ì›í™”ë¡œ ê±°ë˜<br><br>
                    
                    ì´ë¡ ì ìœ¼ë¡œëŠ” (í™˜ìœ¨ Ã— 1ë‹¬ëŸ¬) = ì—…ë¹„íŠ¸ USDT ê°€ê²©ì´ì–´ì•¼ í•˜ì§€ë§Œ,<br>
                    ì‹¤ì œë¡œëŠ” <strong>ìˆ˜ìš”ì™€ ê³µê¸‰</strong>ì— ë”°ë¼ ê°€ê²© ì°¨ì´ê°€ ë°œìƒí•©ë‹ˆë‹¤.<br><br>
                    
                    ì˜ˆì‹œ:<br>
                    â€¢ í™˜ìœ¨: 1ë‹¬ëŸ¬ = 1,400ì›<br>
                    â€¢ ì—…ë¹„íŠ¸ USDT: 1,450ì›<br>
                    â†’ <strong style="color: #e74c3c;">+3.57% ê¹€í”„</strong> (í•œêµ­ì´ ë” ë¹„ìŒˆ)<br><br>
                    
                    ì´ëŸ° ì°¨ì´ê°€ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” í•œêµ­ì˜ ì•”í˜¸í™”í ìˆ˜ìš”,<br>
                    ì†¡ê¸ˆ ê·œì œ, ì‹œì¥ ì‹¬ë¦¬ ë“± ì—¬ëŸ¬ ìš”ì¸ì´ ë³µí•©ì ìœ¼ë¡œ ì‘ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

                </div>

                <div class="info-card">
                    <strong>ğŸ“Š ê¹€í”„ ê³„ì‚° ë°©ì‹</strong><br>
                    ê¹€í”„(%) = (ì—…ë¹„íŠ¸ ê°€ê²© / í™˜ìœ¨ - 1) Ã— 100<br><br>
                    
                    ì˜ˆì‹œ: USDTê°€ ì—…ë¹„íŠ¸ì—ì„œ â‚©1,350, í™˜ìœ¨ì´ â‚©1,300ì¼ ë•Œ<br>
                    â†’ (1,350 / 1,300 - 1) Ã— 100 = <strong>+3.85%</strong><br><br>
                    
                    <strong style="color: #e74c3c;">í”ŒëŸ¬ìŠ¤(+)</strong>: í•œêµ­ì´ ë” ë¹„ìŒˆ (ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„)<br>
                    <strong style="color: #3498db;">ë§ˆì´ë„ˆìŠ¤(-)</strong>: í•œêµ­ì´ ë” ìŒˆ (ê¹€ì¹˜ ë””ìŠ¤ì¹´ìš´íŠ¸)<br><br>

                    ë‹¤ë§Œ ì›ë˜ëŠ” ë°”ì´ë‚¸ìŠ¤ë‚˜ OKX ê°™ì€ í•´ì™¸ ê±°ë˜ì†Œì™€ì˜ ì‹œì„¸ ì°¨ì´ë¥¼ ë¹„êµí•´ì•¼ í•˜ëŠ” ê²ƒì´ ë§ì§€ë§Œ, ì´ ì‚¬ì´íŠ¸ì—ëŠ” í™˜ìœ¨ê³¼ì˜ ë¹„êµë¥¼ í•œëˆˆì— ë³´ê¸° ìœ„í•´ ë‹¤ë¥¸ ê¸°ì¤€ì„ ì ìš©í•œ ìƒíƒœì…ë‹ˆë‹¤.
                    ì›ë˜ ì˜ë¯¸ì˜ ê¹€í”„ ê³„ì‚° ê°’ì„ ë³´ì‹œë ¤ë©´ https://kimpga.com/ ì´ ì‚¬ì´íŠ¸ë¡œ ê°€ì‹œë©´ ë©ë‹ˆë‹¤.
                    
                    <div style="border-top: 1px solid #eee; margin-top: 12px; padding-top: 12px; font-size: 12px;">
                        âš ï¸ <strong>ì•ˆë‚´ì‚¬í•­</strong><br>
                        â€¢ ìë™ ì—…ë°ì´íŠ¸: 90ì´ˆë§ˆë‹¤ (API ë¶€í•˜ ê°ì†Œ)<br>
                        â€¢ 30ì´ˆ ìºì‹±ìœ¼ë¡œ ì¤‘ë³µ ìš”ì²­ ë°©ì§€<br>
                        â€¢ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ì—°ì†ìœ¼ë¡œ ëˆ„ë¥´ì§€ ë§ˆì„¸ìš”<br>
                        â€¢ ì˜¤ë¥˜ ë°œìƒ ì‹œ 2-3ë¶„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì¬ì‹œë„<br>
                        â€¢ ì¬ì‹œë„ ì‹œ ìë™ìœ¼ë¡œ ëŒ€ê¸° ì‹œê°„ì´ ì¦ê°€í•©ë‹ˆë‹¤<br><br>
                        
                        <strong style="color: #e67e22;">ğŸ“Œ ì •í™•í•œ ë°ì´í„°ëŠ” ì§ì ‘ í™•ì¸í•˜ì‹œëŠ” ê²ƒì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.</strong><br>
                        ìµœëŒ€í•œ ì •í™•í•œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë ¤ í•˜ì§€ë§Œ ì•½ê°„ì˜ ì˜¤ì°¨ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ’¡ í˜„ì¬ ê¹€í”„</div>
                    <div style="font-size: 14px; color: #666; line-height: 1.6; margin-top: 8px;">
                        í…Œë” (USDT): <strong class="${data.usdtPremium >= 0 ? 'positive' : 'negative'}">${data.usdtPremium >= 0 ? '+' : ''}${data.usdtPremium}%</strong><br>
                        USDC: <strong class="${data.usdcPremium >= 0 ? 'positive' : 'negative'}">${data.usdcPremium >= 0 ? '+' : ''}${data.usdcPremium}%</strong>
                    </div>
                </div>

                <button class="refresh-btn" onclick="manualRefresh()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            `;

            document.getElementById('content').innerHTML = content;
        }

        // ì´ˆê¸° ë¡œë“œ
        fetchData();

        // 90ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸ (60ì´ˆì—ì„œ 90ì´ˆë¡œ ë³€ê²½í•˜ì—¬ API ë¶€í•˜ ê°ì†Œ)
        setInterval(fetchData, 90000);
    </script>
</body>
</html>

